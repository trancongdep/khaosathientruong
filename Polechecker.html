<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pole Checker v1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        /* Camera Container */
        .camera-container {
            position: relative;
            width: 100%;
            height: 80vh; /* Chiếm 80% chiều cao màn hình */
            background: #000;
            overflow: hidden;
            border-radius: 12px;
        }
        
        #cameraFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Dây dọi điện tử (Plumb Line Interface) */
        .overlay-layer {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 10;
        }

        /* 1. Trục Chuẩn Màn Hình (Fixed Center Line) - Màu Xanh */
        .center-axis {
            position: absolute;
            left: 50%; top: 0; bottom: 0;
            width: 2px;
            background-color: #00ff00; /* Green */
            transform: translateX(-50%);
            box-shadow: 0 0 4px rgba(0,0,0,0.8);
        }
        .center-axis::after {
            content: "TRỤC MÁY";
            position: absolute;
            top: 10px; left: 5px;
            color: #00ff00;
            font-size: 10px;
            font-weight: bold;
            background: rgba(0,0,0,0.5);
            padding: 2px;
        }

        /* 2. Đường Trọng Lực (Gravity Line) - Màu Đỏ/Vàng */
        /* Đường này sẽ được xoay bằng JS theo cảm biến */
        .gravity-line-container {
            position: absolute;
            top: 50%; left: 50%;
            width: 2px; height: 120%; /* Dài hơn màn hình */
            transform-origin: center center; 
            /* JS sẽ set transform: rotate(...) */
        }
        .gravity-line {
            width: 100%; height: 100%;
            background: repeating-linear-gradient(
                to bottom,
                #ff0000 0,
                #ff0000 10px,
                transparent 10px,
                transparent 15px
            ); /* Nét đứt màu đỏ */
            box-shadow: 0 0 2px rgba(255,255,255,0.5);
        }

        /* Angle Display Bubble */
        .angle-bubble {
            position: absolute;
            bottom: 100px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-family: monospace;
            text-align: center;
            border: 2px solid white;
            z-index: 20;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen p-4 flex flex-col items-center">

    <div class="w-full max-w-md flex justify-between items-center mb-4 text-white">
        <h1 class="font-bold text-lg"><i class="fa-solid fa-scale-unbalanced mr-2"></i>Pole Checker v1.0</h1>
        <span id="saveStatus" class="text-xs bg-green-500 px-2 py-1 rounded hidden">Đã lưu!</span>
    </div>

    <button id="requestPermissionBtn" class="w-full max-w-md bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded mb-3 hidden transition">
        <i class="fa-solid fa-compass mr-2"></i>Cấp quyền Cảm biến (iOS)
    </button>

    <div class="camera-container max-w-md shadow-2xl border border-gray-700">
        
        <video id="cameraFeed" autoplay playsinline></video>
        
        <canvas id="captureCanvas" class="hidden"></canvas>
        
        <img id="capturedImage" class="absolute top-0 left-0 w-full h-full object-cover hidden z-30">

        <div id="overlayLayer" class="overlay-layer">
            
            <div class="center-axis"></div>

            <div id="gravityContainer" class="gravity-line-container">
                <div class="gravity-line"></div>
                <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-4 h-4 bg-red-600 rounded-full border border-white"></div>
            </div>

            <div class="angle-bubble">
                <div class="text-xs text-gray-300">ĐỘ NGHIÊNG</div>
                <div id="angleDisplay" class="text-3xl font-bold">0.0°</div>
                <div id="directionDisplay" class="text-xs text-yellow-400 font-bold mt-1">--</div>
            </div>
            
            <div class="absolute top-1/2 left-1/2 w-4 h-4 bg-transparent border-2 border-white rounded-full transform -translate-x-1/2 -translate-y-1/2"></div>
            <div class="absolute top-1/2 left-1/2 w-1 h-1 bg-white rounded-full transform -translate-x-1/2 -translate-y-1/2"></div>

        </div>

        <div class="absolute bottom-6 left-0 right-0 flex justify-center z-40 space-x-6">
            <button id="btnStart" onclick="startCamera()" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg border-2 border-white/20">
                <i class="fa-solid fa-power-off text-xl"></i>
            </button>
            
            <button id="btnCapture" onclick="captureCheck()" class="bg-white hover:bg-gray-200 text-red-600 w-20 h-20 rounded-full shadow-lg border-4 border-gray-400 flex items-center justify-center hidden transform active:scale-95 transition">
                <i class="fa-solid fa-camera text-3xl"></i>
            </button>

            <div id="postCaptureActions" class="hidden flex space-x-4">
                <button onclick="retake()" class="bg-gray-600 text-white p-4 rounded-full shadow-lg">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
                <button id="btnSaveFirebase" onclick="saveToFirebase()" class="bg-red-600 text-white p-4 rounded-full shadow-lg font-bold flex items-center">
                    <i class="fa-solid fa-cloud-arrow-up mr-2"></i> Lưu
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", 
            authDomain: "tavietnam-78ae8.firebaseapp.com", 
            projectId: "tavietnam-78ae8", 
            storageBucket: "tavietnam-78ae8.firebasestorage.app", 
            messagingSenderId: "670121705534", 
            appId: "1:670121705534:web:1027ad98550573ad37116f" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Expose save function globally
        window.saveDataToFirestore = async function(data) {
            const btn = document.getElementById('btnSaveFirebase');
            const originalContent = btn.innerHTML;
            
            try {
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                btn.disabled = true;

                const docRef = await addDoc(collection(db, "pole_checks"), {
                    ...data,
                    timestamp: serverTimestamp(),
                    device_agent: navigator.userAgent
                });

                console.log("Saved ID: ", docRef.id);
                document.getElementById('saveStatus').classList.remove('hidden');
                
                // Reset UI after short delay
                setTimeout(() => {
                    document.getElementById('saveStatus').classList.add('hidden');
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Đã lưu';
                }, 1000);

            } catch (e) {
                alert("Lỗi lưu: " + e.message);
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }
    </script>

    <script>
        // --- Variables ---
        let currentGamma = 0; // Left/Right Tilt (Roll)
        let currentBeta = 0;  // Front/Back Tilt (Pitch)
        let isCameraActive = false;
        let videoStream = null;
        let capturedData = null;

        // --- 1. Camera Logic ---
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } }
                });
                
                videoStream = stream;
                document.getElementById('cameraFeed').srcObject = stream;
                
                // UI Switch
                document.getElementById('btnStart').classList.add('hidden');
                document.getElementById('btnCapture').classList.remove('hidden');
                document.getElementById('capturedImage').classList.add('hidden');
                document.getElementById('overlayLayer').classList.remove('hidden');
                isCameraActive = true;

                // Start Sensor Logic
                initSensors();

            } catch (err) {
                alert("Không thể mở Camera: " + err.message);
            }
        }

        // --- 2. Sensor Logic (Electronic Plumb Line) ---
        function initSensors() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+
                document.getElementById('requestPermissionBtn').classList.remove('hidden');
                document.getElementById('requestPermissionBtn').onclick = () => {
                    DeviceOrientationEvent.requestPermission().then(resp => {
                        if (resp === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                            document.getElementById('requestPermissionBtn').classList.add('hidden');
                        }
                    }).catch(console.error);
                };
            } else {
                // Android / Standard
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }

        function handleOrientation(event) {
            if (!isCameraActive) return;

            // Gamma: Góc nghiêng trái/phải (-90 đến 90). Đây là thông số quan trọng nhất để check cột thẳng đứng.
            // Beta: Góc nghiêng trước/sau. Dùng để nhắc người dùng giữ máy thẳng.
            
            const gamma = event.gamma; 
            const beta = event.beta; 
            
            if (gamma === null) return;

            currentGamma = gamma;
            currentBeta = beta;

            updateUI(gamma, beta);
        }

        function updateUI(gamma, beta) {
            const angleDisplay = document.getElementById('angleDisplay');
            const dirDisplay = document.getElementById('directionDisplay');
            const gravityLine = document.getElementById('gravityContainer');
            const bubble = document.querySelector('.angle-bubble');

            // 1. Rotate the "Gravity Line"
            // Nếu điện thoại nghiêng sang phải (Gamma dương), trọng lực "kéo" sang trái so với màn hình.
            // Do đó ta xoay ngược lại giá trị gamma.
            gravityLine.style.transform = `rotate(${-gamma}deg)`;

            // 2. Display Values
            const absGamma = Math.abs(gamma);
            angleDisplay.innerText = absGamma.toFixed(1) + "°";

            // 3. Direction & Color Logic
            if (absGamma < 1.0) {
                // OK - Khá thẳng
                bubble.style.borderColor = "#00ff00"; // Green border
                angleDisplay.style.color = "#00ff00";
                dirDisplay.innerText = "THẲNG ĐỨNG (OK)";
                dirDisplay.style.color = "#00ff00";
            } else {
                // Nghiêng
                bubble.style.borderColor = "#ff0000"; // Red border
                angleDisplay.style.color = "#ffcc00"; // Yellow text
                if (gamma > 0) {
                    dirDisplay.innerText = "MÁY NGHIÊNG PHẢI";
                    // Tức là cột đang nghiêng trái so với máy (nếu máy song song cột)
                } else {
                    dirDisplay.innerText = "MÁY NGHIÊNG TRÁI";
                }
            }

            // Optional: Warning if holding phone flat (like looking at map)
            if (beta < 45 && beta > -45) {
               dirDisplay.innerText = "DỰNG MÁY LÊN!";
               dirDisplay.style.color = "red";
            }
        }

        // --- 3. Capture & Drawing ---
        function captureCheck() {
            if (!videoStream) return;
            const video = document.getElementById('cameraFeed');
            const canvas = document.getElementById('captureCanvas');
            const ctx = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // 1. Draw Video Frame
            ctx.drawImage(video, 0, 0);

            // 2. Draw Overlay Data onto Canvas (So result image proves the measurement)
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;

            // Draw Fixed Center Axis (Green)
            ctx.beginPath();
            ctx.strokeStyle = "#00ff00";
            ctx.lineWidth = 4;
            ctx.moveTo(cx, 0);
            ctx.lineTo(cx, canvas.height);
            ctx.stroke();

            // Draw Gravity Line (Red) - Rotated by Gamma
            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(-currentGamma * Math.PI / 180); // Rotate canvas context
            
            ctx.beginPath();
            ctx.strokeStyle = "red";
            ctx.lineWidth = 3;
            ctx.setLineDash([15, 10]); // Dashed line
            ctx.moveTo(0, -canvas.height); // Draw long line
            ctx.lineTo(0, canvas.height);
            ctx.stroke();
            ctx.restore();

            // Draw Angle Text Box
            ctx.fillStyle = "rgba(0,0,0,0.6)";
            ctx.fillRect(20, canvas.height - 150, 300, 100);
            
            ctx.fillStyle = "white";
            ctx.font = "bold 40px Arial";
            ctx.fillText(`Góc: ${Math.abs(currentGamma).toFixed(1)}°`, 40, canvas.height - 90);
            
            ctx.font = "20px Arial";
            ctx.fillStyle = Math.abs(currentGamma) < 1 ? "#00ff00" : "yellow";
            const statusText = Math.abs(currentGamma) < 1 ? "ĐẠT YÊU CẦU" : "BỊ NGHIÊNG";
            ctx.fillText(statusText, 40, canvas.height - 60);

            // Display result
            const dataURL = canvas.toDataURL('image/jpeg');
            const imgDisplay = document.getElementById('capturedImage');
            imgDisplay.src = dataURL;
            imgDisplay.classList.remove('hidden');

            // Save Data for Cloud
            capturedData = {
                tilt_angle: currentGamma,
                pitch_beta: currentBeta,
                status: Math.abs(currentGamma) < 1 ? "PASS" : "FAIL",
                image_base64: (dataURL.length < 500000) ? dataURL : "skipped_large"
            };

            // Switch UI
            document.getElementById('btnCapture').classList.add('hidden');
            document.getElementById('overlayLayer').classList.add('hidden'); // Hide live overlay
            document.getElementById('postCaptureActions').classList.remove('hidden');
            document.getElementById('postCaptureActions').classList.add('flex');
        }

        function retake() {
            document.getElementById('capturedImage').classList.add('hidden');
            document.getElementById('postCaptureActions').classList.add('hidden');
            document.getElementById('postCaptureActions').classList.remove('flex');
            document.getElementById('btnCapture').classList.remove('hidden');
            document.getElementById('overlayLayer').classList.remove('hidden');
        }

        function saveToFirebase() {
            if(window.saveDataToFirestore && capturedData) {
                window.saveDataToFirestore(capturedData);
            }
        }
    </script>
</body>
</html>
